<script type="text/javascript" charset="utf-8">
  function modify_main_menu(menu) {
    var new_menu = [];
    $.each(menu,
      function (index,item) {
				if (!(/right/.test(item.id))) {
          new_menu[new_menu.length] = item;
        }
      }
    );
    return new_menu;
  }
  
	function extjs_body_items() {
		return init_lico_adva_crud({
			columns: [{
				label: 'titel',
				name: 'title',
				type: 'string',
				submit_value: 'issue[title]'
			},{
				label: 'Concept',
				name: 'draft',
				type: 'boolean',
			}],
			add_record_path: '<%= admin_adva_issues_path(@site.id, @newsletter.id) %>',
			add_record_post: [{
				key: "issue[body]",
				value: "&nbsp;"
			}],
      store: {
        url: '<%= url_for admin_adva_issues_path(@site.id, @newsletter) %>.xml',
        sort: {
          by: 'title',
          order: 'asc'
        }
      },
      grid: {
        empty_details: 'Selecteer een uitgave voor meer details'
      },
      show: {
        url: '<%= edit_admin_adva_issue_path(@site, @newsletter, '!recordid!') %>',
        custom_form: edit_issue_form,
        custom_form_values: edit_issue_form_values
      },
      edit: {
        url: '<%= admin_adva_issue_path(@site, @newsletter, '!recordid!') %>'
      },
      destroy: {
        url: '<%= admin_adva_issue_path(@site, @newsletter, '!recordid!') %>',
        message: 'Weet u zeker dat u deze uitgave wilt verwijderen?'
      }
    });
  }
  
	function edit_issue_form_values (parameters) {
		parameters["issue[title]"] = document.getElementById('title').value;
		parameters["issue[body]"] = document.getElementById('body').value;
		parameters["issue[draft]"] = document.getElementById('state').checked ? "1" : "0";
		if (document.getElementById('tracking_campaign')) {
		  parameters["issue[tracking_campaign]"] = document.getElementById('tracking_campaign').value;
		  parameters["issue[tracking_source]"] = document.getElementById('tracking_source').value;
		}
		if (document.getElementById('filter')) {
		  parameters["issue[filter]"] = document.getElementById('filter').value;
	  }

		return parameters;
	}
  
	function edit_issue_form (record) {
		var title = xmlvalue(record,"title");
		var body = xmlvalue(record,"body");
		var state = xmlvalue(record,"state");
		selected_record_title = title;
		var tracking_campaign = xmlvalue(record,"tracking_campaign");
		var tracking_source = xmlvalue(record,"tracking_source");
		var filter = xmlvalue(record,"filter");

		return [{
			xtype: 'tabpanel',
			plain: true,
			activeTab: 0,
			defaults: {
				bodyStyle: 'padding:10px'
			},
			items: [{
				title: 'Issue',
				layout: 'column',
				border: false,
				items: [{
					columnWidth: .5,
					layout: 'form',
					border: false,
					items: [{
						xtype: 'textfield',
						fieldLabel: 'titel',
						id: 'title',
						name: 'title',
						value: title
					},{
						fieldLabel: 'Body',
						xtype: 'htmleditor',
						height: 150,
						name: 'body',
						id: 'body',
						value: body
					}]
				},{
					columnWidth: .5,
					layout: 'form',
					border: false,
					items: [{
						xtype: 'checkbox',
						fieldLabel: 'Concept',
						id: 'state',
						name: 'state',
						checked: state == "draft",
						mode: 'local'
					}]
				}]
			},{
				title: 'Tracking',
				layout: 'column',
				border: false,
				items: [{
					columnWidth: .5,
					layout: 'form',
					border: false,
					items: [{
						xtype: 'textfield',
						fieldLabel: 'tracking_campaign',
						id: 'tracking_campaign',
						name: 'tracking_campaign',
						value: tracking_campaign
					},{
						xtype: 'textfield',
						fieldLabel: 'tracking_source',
						id: 'tracking_source',
						name: 'tracking_source',
						value: tracking_source
					}]
				}]
			},{
				title: 'Filter',
				layout: 'column',
				border: false,
				items: [{
					columnWidth: .5,
					layout: 'form',
					border: false,
					items: [{
						xtype: 'combo',
						fieldLabel: 'Filter',
						name: 'filter',
						hiddenName: 'filter',
						hiddenId: 'filter',
						value: xmlvalue(record, "filter"),
						mode: 'local',
						valueField: 'item_id',
						displayField: 'text',
						triggerAction: 'all',
						store: new Ext.data.ArrayStore({
						  fields: ['item_id','text'],
						  data: <%= filter_options.collect{|a| [a[1],a[0]]}.to_json().to_s %>
						})
					}]
				}]
			}]
		}];
	}
</script>
<% content_for :sidebar do -%>
<% end -%>
